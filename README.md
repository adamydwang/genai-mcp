## GenAI MCP Server

This project implements a **Model Context Protocol (MCP) server** for image generation and image editing using **Google Gemini** (via `google.golang.org/genai`), plus optional automatic upload of generated images to **S3‑compatible object storage** (AWS S3, Aliyun OSS, etc.).

The server exposes a **streamable HTTP MCP endpoint** and provides two tools:

- `gemini_generate_image` – text → image
- `gemini_edit_image` – image + text → edited image

You can control:

- Whether the final output should be **base64 data URI** or an **object storage URL**
- Whether and how images are uploaded to OSS / S3
- Logging level / format / output
- Request timeout

### Gemini / Nano Banana backend support

This MCP server currently supports the following Gemini‑compatible backends:

1. **Google official Gemini API**  
   - Use the default `GENAI_BASE_URL=https://generativelanguage.googleapis.com`  
   - `GENAI_API_KEY` is a Google Gemini API key

2. **dmxapi (Gemini‑compatible third‑party gateway)**  
   - Set `GENAI_BASE_URL` to the dmxapi Gemini endpoint (for example `https://www.dmxapi.cn`)  
   - `GENAI_API_KEY` is the key issued by dmxapi  
   - As long as the endpoint implements the `google.golang.org/genai` compatible Gemini API, no code changes are needed

---

### 1. Prerequisites

- Go **1.21+** (recommended; `go.mod` uses module mode)
- A valid Gemini API key
- Optional: S3 / OSS bucket for storing images

---

### 2. Configuration (`.env`)

Copy `env.example` to `.env`, then fill in real values.

**GenAI configuration**

```env
GENAI_BASE_URL=https://generativelanguage.googleapis.com
GENAI_API_KEY=your_api_key_here
GENAI_MODEL_NAME=gemini-3-pro-image-preview

# Request timeout in seconds for each Gemini call (generate / edit)
GENAI_TIMEOUT_SECONDS=120

# Image output format:
# - base64: return image as data URI (base64 encoded)
# - url:    upload image to OSS and return plain URL
GENAI_IMAGE_FORMAT=base64
```

**HTTP server**

```env
SERVER_ADDRESS=0.0.0.0
SERVER_PORT=8080
```

MCP endpoint will listen on:

```text
http://SERVER_ADDRESS:SERVER_PORT/mcp
```

**OSS / S3 configuration (optional, required when `GENAI_IMAGE_FORMAT=url`)**

```env
# For AWS S3: leave OSS_ENDPOINT empty or set to s3.amazonaws.com
# For Aliyun OSS: set to oss-cn-hangzhou.aliyuncs.com or your region
# For Tencent COS: set to cos.ap-guangzhou.myqcloud.com
# For MinIO: set to your MinIO endpoint
OSS_ENDPOINT=
OSS_REGION=us-east-1
OSS_ACCESS_KEY=your_access_key_here
OSS_SECRET_KEY=your_secret_key_here
OSS_BUCKET=your_bucket_name
```

When `GENAI_IMAGE_FORMAT=url`:

- For **Aliyun OSS**: make sure
  - `OSS_ENDPOINT` is like `oss-cn-beijing.aliyuncs.com`
  - The bucket policy allows read access if you expect the returned URL to be publicly accessible

**Logging**

```env
LOG_LEVEL=info   # debug, info, warn, error
LOG_FORMAT=text  # text or json
LOG_OUTPUT=stdout  # stdout, stderr, file
LOG_FILE=logs/app.log  # when LOG_OUTPUT=file
```

Logs include:

- Timestamp
- Level
- File name and line number (`file="client.go:120"`)
- Structured fields (model, bucket, key, etc.)

Sensitive data (like full base64 image contents) are **never** logged.

---

### 3. Running the MCP Server

In the project root:

```bash
go run ./server.go
```

By default the MCP HTTP endpoint will be:

```text
http://127.0.0.1:8080/mcp
```

You can connect to this MCP endpoint from any MCP‑compatible client (e.g. Code editors or tools that support the streamable HTTP MCP transport).

---

### 4. MCP Tools

The server registers two tools in `internal/tools/gemini.go`:

- **`gemini_generate_image`**
  - **Input**:
    - `prompt` (string, required): text prompt describing the image
  - **Output**:
    - When `GENAI_IMAGE_FORMAT=base64`: a `data:image/...;base64,...` string
    - When `GENAI_IMAGE_FORMAT=url`: an OSS/S3 URL generated by the server

- **`gemini_edit_image`**
  - **Input**:
    - `prompt` (string, required): how to edit the image
    - `image_url` (string, required): original image URL or data URI
  - **Output**:
    - Same format as above (`base64` or `url`), depending on configuration

When `GENAI_IMAGE_FORMAT=url`:

- Generated / edited images are:
  - Downloaded (if Gemini returns a URL), or decoded (if it returns inline data)
  - Re‑uploaded to OSS / S3
  - Stored under key pattern: `images/yyyy-MM-dd/{uuid_timestamp_random}.ext`

---

### 5. Python Test Scripts

There is a `tests` directory with ready‑to‑use Python scripts:

- `mcp_client.py`: a simple MCP HTTP client wrapper
- `test_list_tools.py`: list all tools exposed by the MCP server
- `test_generate_image.py`: test image generation
- `test_edit_image.py`: test image editing
- `run_all_tests.py`: run the above tests in sequence

Install dependencies:

```bash
cd tests
pip install -r requirements.txt
```

Run tests (server must already be running on `http://127.0.0.1:8080/mcp`):

```bash
python test_list_tools.py
python test_generate_image.py "A beautiful sunset over mountains"
python test_edit_image.py "Make it blue" "https://example.com/image.jpg"
```

---

### 6. Logging & Debugging Notes

- All key operations (Gemini calls, OSS uploads, HTTP errors) are logged with file name & line number.
- Binary / base64 image data are **never** logged. Only lengths and flags (e.g. `is_data_uri`, `is_http_url`) are recorded when needed.
- For OSS issues (e.g. Aliyun OSS), check logs for:
  - HTTP status codes
  - Bucket / key used
  - Endpoint and region

---

### 7. Contact

- **WeChat**: Scan the QR code below to add as a friend  

  ![WeChat QR Code](assets/wechat_qrcode.png)

- **Discord**: Username `adamydwang`
